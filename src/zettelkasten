#!/usr/bin/env bash

set -e
export ZETTEL_WORKDIR="$(cd "$(dirname "$0")" && pwd)"
export $(cat "$ZETTEL_WORKDIR/../config" | xargs)

source "$ZETTEL_WORKDIR/globals"
source "$ZETTEL_WORKDIR/common"

cli_help() {
    cli_name="${0##*/}"
    echo "
   XETTELKASTEN CLI
   ------------------------------------ Version: $(cat "$ZETTEL_WORKDIR/VERSION")
    Usage: $cli_name [command]

   Commands:
   ------------------------------------
    init      initialize xettelkasten
    ref       manage references
    go        navigate
    zettel    create/remove zettel
    status    output open zettel
    *         Help
    "
    exit 1
}

expand_main() {
    echo "$(
        export PREAMBLE="$PREAMBLE_FILE"
        envsubst < "$MAIN_TEMPLATE"
    )"
}

copy_files() {
        log "copy preamble"
        cp  "$ZETTEL_PREAMBLE" "$ZETTEL_DATA/$PREAMBLE_FILE"

        log "creating new glossary file"
        echo "$(expand_main)" > "$ZETTEL_DATA/glossary.tex" 

        log "copying custom files"
        for f in "$ZETTEL_WORKDIR"/../base/_*; do
            [ -f "$f" ] || continue
            name="$(basename "$f")"
            new_name="${name#_}"
            cp "$f" "$ZETTEL_DATA/$new_name"
        done
}

init_kasten() {
    if [ -d "$ZETTEL_DATA" ]; then
        info "reinitializing"
        copy_files
        exit
    fi
    info "initializing new zettelkasten"
    mkdir "$ZETTEL_DATA"
    copy_files
}

CMD=$ZETTEL_WORKDIR/commands

case "$1" in
    init)
        init_kasten && exit
        ;;
    ref)
        check_kasten
        shift
        "$CMD/ref" "$@"
        ;;
    go)
        check_kasten
        shift
        "$CMD/go" "$@"
        ;;
    zettel)
        check_kasten
        shift
        "$CMD/zettel" "$@"
        ;;
    git)
        check_kasten
        shift
        "$CMD/git" "$@"
        ;;
    status)
        check_kasten
        echo "currently viewing $(viewing)"
        ;;
    list)
        check_kasten
        for zettel in $(zettel_list); do echo "$ZETTEL_DATA/$zettel"; done
        ;;
    api)
        # this is a bit hacky, we just inject some command
        # into this script and run it with the context of
        # contex of ./common, this allows us to execute 
        # most internal functions from the cli
        #
        # -> please use with the most care.
        check_kasten
        shift
        "$@"
        ;;
    *)
        cli_help
        ;;
esac
