#!/usr/bin/env bash

source "$ZETTEL_WORKDIR/editor"

log() {
	script_name=${0##*/}
	timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
	>&2 echo "== $script_name $timestamp" "$@" 
}

check_kasten() {
    if ! [[ -d $ZETTEL_DATA ]]; then
        info "no zettelkasten - please run init"
        info "$ZETTEL_DATA does not exist"
        exit
    fi
    log "kasten directory: check passed"
}

reference_file() {
    current_zettel=$1
    references="$ZETTEL_DATA/$current_zettel/${REFERENCE_FILENAME}"
    echo "$references"
}

open_zettel() {
    log "before open hook..."
    "$ZETTEL_WORKDIR/../custom_hooks/before_open" "$(viewing)" || log "before open hool failed"

	log "open zettel $1"
    zettel=$(basename "$1")
    if [[ -z $zettel ]]; then
		log "nothing to do, exiting"
        info "nothing to do"
        exit
    fi
    filepath="$ZETTEL_DATA/$zettel/$ZETTEL_FILENAME"
	log "filepath: $filepath"
    if ! [[ -f $filepath ]]; then
		log "does not exist"
        info "$zettel does not exist."
        exit
    fi
	log "nvim remote"
    editor_edit "$filepath"

    log "after open hook"
    "$ZETTEL_WORKDIR/../custom_hooks/after_open" "$(viewing)" || log "after open hool failed"
}

zettel_list() {
    list="$(find "$ZETTEL_DATA" -mindepth 1 -maxdepth 1 -type d)"
    for zettel in $list
    do
        printf %"s\n" "$(basename "$zettel")"
    done
}
